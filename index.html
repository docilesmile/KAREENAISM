<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KAREENAISM Task Spinner</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      text-align: center;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      background: #e91e63;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Praise Goddess KAREENA</h1>
  <p id="taskDisplay">Click below to receive your holy commandment.</p>
  <button id="getTaskBtn" disabled>Get Task</button>
  <p id="completionStatus"></p>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const supabaseUrl = "https://djdhtdrseqfaiskvbvhb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqZGh0ZHJzZXFmYWlza3ZidmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODEyNDMsImV4cCI6MjA3MTg1NzI0M30.sLHzX-UMZfjp5cWn0ii3nDUI9jmxGt5SigOI7jEg_ew";
    const supabase = createClient(supabaseUrl, supabaseKey);

    const getTaskBtn = document.getElementById("getTaskBtn");
    const taskDisplay = document.getElementById("taskDisplay");
    const completionStatus = document.getElementById("completionStatus");

    let currentUser = null;
    let tasksCompleted = 0;

    async function fetchChastityStatus(userId) {
      console.log("Fetching chastity status for:", userId);
      const { data, error } = await supabase
        .from("chastityStatus")
        .select("*")
        .eq("user_id", userId)
        .single();

      if (error) {
        console.error("Chastity status fetch error:", error);
      } else {
        console.log("Fetched chastity status:", data);
      }
      return { data, error };
    }

    async function updateChastityStatus(userId, adjustment) {
      console.log("Updating chastity status by:", adjustment, "minutes");

      // Fetch existing status
      const { data: existing, error: fetchError } = await supabase
        .from("chastityStatus")
        .select("*")
        .eq("user_id", userId)
        .single();

      if (fetchError) {
        console.error("Error fetching for update:", fetchError);
        return;
      }
      console.log("Existing status before update:", existing);

      let releaseDate = existing?.release_date ? new Date(existing.release_date) : new Date();
      releaseDate.setMinutes(releaseDate.getMinutes() + adjustment);

      const { error: updateError } = await supabase
        .from("chastityStatus")
        .update({
          release_date: releaseDate.toISOString(),
          is_locked: true
        })
        .eq("user_id", userId);

      if (updateError) {
        console.error("Error updating chastity status:", updateError);
      } else {
        console.log("Chastity status updated successfully. New release date:", releaseDate);
      }
    }

    async function fetchTask() {
      const { data, error } = await supabase
        .from("TaskLists")
        .select("*")
        .limit(1)
        .order("RANDOM()");

      if (error) {
        console.error("Error fetching task:", error);
        return null;
      }
      console.log("Fetched task:", data[0]);
      return data[0];
    }

    async function markTaskCompleted(userId, taskId) {
      console.log("Marking task completed:", taskId, "by user:", userId);
      const { error } = await supabase
        .from("rolled_tasks")
        .insert([{ user_id: userId, task_id: taskId, completed: true }]);

      if (error) {
        console.error("Error marking task completed:", error);
      } else {
        console.log("Task marked completed successfully");
      }
    }

    getTaskBtn.addEventListener("click", async () => {
      const task = await fetchTask();
      if (!task) return;

      taskDisplay.textContent = task.task;
      await markTaskCompleted(currentUser.id, task.id);

      tasksCompleted++;
      completionStatus.textContent = `${tasksCompleted} tasks completed`;

      // Chastity adjustment logic
      if (currentUser) {
        const adjustment = task.difficulty === "hard" ? 30 : -10; 
        await updateChastityStatus(currentUser.id, adjustment);
      }

      if (tasksCompleted >= 5) {
        getTaskBtn.disabled = false;
      }
    });

    async function init() {
      console.log("Initializingâ€¦");
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      console.log("Current user:", currentUser);

      if (!currentUser) {
        taskDisplay.textContent = "Please sign in.";
        return;
      }

      const { data, error } = await fetchChastityStatus(currentUser.id);
      if (error || !data) {
        taskDisplay.textContent = "No chastity status found.";
        return;
      }

      taskDisplay.textContent = "Chastity status loaded. Begin tasks.";
      getTaskBtn.disabled = false;
    }

    init();
  </script>
</body>
</html>

