<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KAREENAISM Task Spinner</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; }
    .task { margin: 5px 0; }
    .done { text-decoration: line-through; color: gray; }
  </style>
</head>
<body>
  <h1>Praise Goddess KAREENA!</h1>

  <!-- Login -->
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="login">Login</button>
  <button id="logout" style="display:none;">Logout</button>

  <hr>

  <!-- Placeholder for modules -->
  <div id="modulesContainer">
    Loading Modules from Goddess KAREENA's will...
  </div>

  <hr>

  <!-- Release -->
  <button id="begRelease" disabled>Beg for Release</button>
  <p id="releaseOutput"></p>

  <script type="module">
    // ---------------- Supabase Init ----------------
    const supabase = window.supabase.createClient(
      "https://djdhtdrseqfaiskvbvhb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqZGh0ZHJzZXFmYWlza3ZidmhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODEyNDMsImV4cCI6MjA3MTg1NzI0M30.sLHzX-UMZfjp5cWn0ii3nDUI9jmxGt5SigOI7jEg_ew"
    );

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const begReleaseBtn = document.getElementById("begRelease");
    const releaseOutput = document.getElementById("releaseOutput");

    let currentUser = null;
    window.currentUser = null;

    // ---------------- Auth ----------------
    loginBtn.addEventListener("click", async () => {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: emailInput.value,
        password: passwordInput.value,
      });
      if (error) return alert(error.message);

      currentUser = data.user;
      window.currentUser = currentUser;

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      // Load Tasks Module with Supabase client and update callback
      const { loadTasksModule } = await import('./tasksModule.js');
      loadTasksModule(supabase, updateBegRelease);

      // Load Chastity Module with Supabase client
      const { loadChastityModule } = await import('./chastityModule.js');
      loadChastityModule(supabase);
    });

    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      currentUser = null;
      window.currentUser = null;

      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";

      document.getElementById("modulesContainer").innerHTML = "Loading Modules from Goddess KAREENA's will...";
      begReleaseBtn.disabled = true;
      releaseOutput.innerText = "";
    });

    // ---------------- Release ----------------
    begReleaseBtn.addEventListener("click", async () => {
      if (!window.currentUser) return;

      // Get latest chastity status
      const { data: statusData, error: statusErr } = await supabase
        .from("chastityStatus")
        .select("*")
        .eq("user_id", window.currentUser.id)
        .order('created_at', { ascending: false })
        .limit(1);

      if (statusErr) return console.error(statusErr);

      const latest = statusData && statusData[0];
      const now = new Date();

      // Check if locked
      if (latest && latest.is_locked && new Date(latest.release_date) > now) {
        // Goddess KAREENA decides
        const mercyRoll = Math.random() * 100; // 0-100
        if (mercyRoll <= 5) {
          // 5% chance of mercy
          await supabase
            .from("chastityStatus")
            .update({ is_locked: false, release_date: now, source: "Goddess KAREENA's mercy" })
            .eq("id", latest.id);

          releaseOutput.innerText = "Goddess KAREENA has taken pity on you and grants early release… for now. Praise Her!";
        } else {
          // Goddess refuses → add punishment
          const extraDays = Math.floor(Math.random() * 2) + 1; // +1 to 2 days
          const newReleaseDate = new Date(latest.release_date);
          newReleaseDate.setDate(newReleaseDate.getDate() + extraDays);

          await supabase
            .from("chastityStatus")
            .update({ release_date: newReleaseDate, source: "Goddess KAREENA adds time as punishment" })
            .eq("id", latest.id);

          releaseOutput.innerText = `Goddess KAREENA refuses your plea. She extends your chastity by ${extraDays} day(s) and may add extra tasks.`;
        }

        // Refresh Chastity Module
        const { loadChastityModule } = await import('./chastityModule.js');
        loadChastityModule(supabase);

      } else {
        // Not locked → normal release option
        const { data: options, error } = await supabase
          .from("releaseOptions")
          .select("*");

        if (error) return console.error(error);

        const randomOption = options[Math.floor(Math.random() * options.length)];
        releaseOutput.innerText = `Goddess KAREENA says: ${randomOption.decision}`;
      }

      begReleaseBtn.disabled = true;
    });

    // Function to enable Beg Release after 5 tasks
    function updateBegRelease(completedTasks) {
      begReleaseBtn.disabled = completedTasks < 5;
    }
  </script>
</body>
</html>
